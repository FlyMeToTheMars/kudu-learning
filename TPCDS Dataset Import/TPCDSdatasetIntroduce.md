本文包含：
    
    # 1，背景
    # 2，TPC-DS简介
    # 3，TPC-DS基准
    # 4，TPC-DS数据模型
    # 5，TPC-DS业务模型
    # 6，TPC-DS测试模式
    # 7，TPC-DS度量方法
    # 8，TPC-DS工具介绍
    # 9，TPC-DS批量建表语句（hive/impala，kudu）
    # 10, TPC-DS数据生成与加载

# 1，背景

数据仓库是决策支持系统 (Decision Support System ,DSS) 的重要组成部分，其核心组件一一数据库管理系统(Database Management System , DBMS) 的性能解决方案(如物化视图、分区表、位图索引等)及商务智能套件(如 OLAP ，ETL) 影响 DSS 的可用性。因此事务处理性能委员会(Transaction Processing Performance Counci1 , TPC) 已制定了一系列面向决策支持系统的数据库性能基准

目前在用的 TPC-H 基准已很难模拟日益复杂的 DSS 业务需求。例如 TPC-H 的数据模型是第三范式，不是目前普遍采用的星座模型，它的业务类型 (22 个查询)很难体现位图索引、物化视图等现代 DBMS 查询引擎的优势，而且它的数据表数据特征单一(如数据不倾斜) ，其数据维护功能(rf1，rf2)仅仅限制了潜在的对索引的过度使用，而没有测试 DBMS 执行真实数据维护操作一一数据提取、转换和加载( ExtractionTransformation-Loading , ETL) 功能的能力。为此， TPC 组织在推出了新一代的面向决策应用的 TPC-DS 基准

TPC-DS 基准将帮助加快硬件和数据库技术的发展来鼓励研究和发展海量数据查询的优化技术。 TPC-DS 也会被硬件厂商和数据库厂商使用来说明他们产品对 DSS 的支持能力，被客户作为某个购买决定的重要因素之一。因此，如何基于 TPC-DS 测试 DBMS 对 DSS 应用的支持能力，衡量其数据仓库解决方案及其各种技术的可用性等，需要一个满足不同DBMS 性能评测的支持工具。

# 2，TPC-DS简介

TPC-H是一款面向商品零售业的决策支持系统测试基准，它定义了8张表，22个查询，遵循SQL92。

TPC-DS采用星型、雪花型等多维数据模式。它包含7张事实表，17张纬度表平均每张表含有18列。其工作负载包含99个SQL查询，覆盖SQL99和2003的核心部分以及OLAP。这个测试集包含对大数据集的统计、报表生成、联机查询、数据挖掘等复杂应用，测试用的数据和值是有倾斜的，与真实场景非常相似。可以说TPC-DS是与真实场景非常接近的一个测试集，也是难度较大的一个测试集。

# 3，TPC-DS基准

TPC-DS 基准意图提供一个公平和诚实的业务和数据模型，以衡量 DBMS 系统的整体性能，如 CPU 与内存使用，I/O负载特征以及操作系统和 DBMS 完成海量数据复杂计算等。它主要关注:

* 1) 共享维度的多雪花模式 :24 个平均含有 18 列的数据库表及丰富的主外键约束。
* 2) 随机替换的 99 个不同的 SQL 查询:随机的、报告的、迭代的、抽取的查询。
* 3) 更具代表性的不对称的倾斜的测试数据:非事实数据表的子线性比例划分。
* 4) 类 ETL 数据维护等。

# 4，TPC-DS数据模型

TPC-DS 基准模拟零售企业三种销售渠道(店铺、网络、目录)的销售和退货业务，包含了客户和典型销售渠道的产品数据订单等。基准设计了 7 张事实表、 17 张维度表和 104 个保持数据完整性的外键约束条件。 7 张事实表为 :3 种销售渠道的销售和退回业务数据表以及库存销售业务数据表。

TPC-DS 基准采用雪花模型和星座模型温合方式来表示被测数据仓库中事实和维的关系。下图展示了店铺销售的雪花模型，店铺销售为事实表，日期、时间、店铺、商品、用户和促销等为维度表，用户统计、用户地址、家庭统计和收入范围对上述纬度表进行层次和粒度上的分解，这样就形成了以店铺销售事实表为中心的雪花模型。

<img src="https://github.com/jimmy-src/img/blob/master/tpcds/tpcdsmodel.jpg" width = "" height = "" alt="图片名称" align=center />

基准的测试数据集规模通过离散的比例因子分 7 级。数据集内的比例划分有两种不同的特点:一种是数据集中的元组数量是扩展的，但是其对应的值的集合(域)是静态的;另一种是元组的数量是固定的，但是产生元组的值的域是扩展的。 TPC-DS 基准选择使用混合的方法。很多表的列都采用数据集比例划分而不是域的比例划分，尤其是事实数据表。TPC 给出了基准测试数据生成程序。

# 5，TPC-DS业务模型

TPC-DS 基准提供了两种重要的业务模型:用户查询和数据维护。查询是把操作性的事实转化为商业情报，而数据维护操作是将数据仓库数据与操作数据库进行同步。

TPC-DS 基准业务如图所示: 

1) 基准提供了被测试数据库测试数据生成程序生成测试数据文本文件，测试人员通过使用 ETL 工具将其装载到被测 DBMS;
2) 基准提供 99 个查询模板及查询语句生成程序，这些查询模板模拟迭代的OLAP 查询、数据挖掘工具的抽取查询、即席( ad-hot) 查询以及大量定制的常见的报表查询 ;
3) 基准提供了5 种方法模拟现实应用的 ETL 过程，包括不需保留历史记录的维度数据维护，需保留历史记录的维度数据维护，事实表数据插入和数据删除维护以及库存表数据删除维护。

<img src="https://github.com/jimmy-src/img/blob/master/tpcds/tpcdsbusiness.jpg" width = "" height = "" alt="图片名称" align=center />

# 6，TPC-DS测试模式

TPC-DS 测试分为:测试数据加载、查询顺序执行 (Power)和并行执行( Throughput) 测试。测试数据加载主要包括:被测系统准备、数据文件生成、测试数据库创建、基础表创建、数据加载、约束验证、辅助数据结构(如索引)创建、表和辅助数据统计分析等。 Power 测试是用于评测数据库对单个查询流的处理能力。 Throughput 测试是用于测试 DBMS 对多个查询流并发查询和操作的处理能力，分为数据查询和数据维护各两个子步骤。所以一个完整的 TPC-DS 测试执行模式如图所示。

<img src="https://github.com/jimmy-src/img/blob/master/tpcds/tpcdstest.jpg" width = "" height = "" alt="图片名称" align=center />

数据查询是 TPC-DS 基准测试的核心

* 在 Power 测试中，99 个数据查询形成的查询流只执行一次，用于评测数据库对单个查询流的处理能力。
* 在 Throughput 测试中，数据查询执行两次，每次执行至少 20 个以上的并行查询流，模拟多个用户同时对数据库的查询操作。
* 为了适应多查询流，数据库优化组件必须依据数据规模进行规划，每个用户也要有足够的临时空间来保存大量的中间结果集。这样 DBMS 能找出并行用户的最佳执行计划

下图展示了 TPC-DS 基准查询所使用的 SQL 特征及数量。

<img src="https://github.com/jimmy-src/img/blob/master/tpcds/tpcdstrait.jpg" width = "" height = "" alt="图片名称" align=center />

# 7，TPC-DS度量方法

TPC-DS 基准定义了两个评价指标:

1) 反映每秒的有效查询数据量的性能指标，其计算公式为: QphDS@ SF ( SF 是数据库规模因子，单位为 GB ，最小为 100 GB) ，值越大说明性能越高 ;
2) 反映每秒每查询数据量的性价比指标，值越小说明性价比越高，其计算公式为 $/QphDS@SF 。

# 8，TPC-DS工具介绍

<img src="https://github.com/jimmy-src/img/blob/master/tpcds/tpcdstools.jpg" width = "" height = "" alt="图片名称" align=center />

# 9，TPC-DS批量建表语句（hive/impala，kudu）

*  hive中的建表语句见alltables.sql
*  见TPCDStableCreateInImpalaFor1000.md文件，包含了kudu中的建表语句

# 10, TPC-DS数据生成与加载

* 数据生成见dataGenerateUseTCP-DS.md
* 数据手动导入见根目录README.md
* 数据批量导入见本目录src，spark批量导入


主要参考论文：TPC-DS 性能测试工具的实现